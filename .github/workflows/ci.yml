name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-ci:
    name: Backend CI (migrations + tests)
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/valuation_db
      DB_HOST: localhost
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: valuation_db
      PGHOST: localhost
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: valuation_db

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Postgres (docker)
        shell: bash
        run: |
          echo "Starting Postgres container..."
          docker run --name ci-postgres -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=valuation_db -p 5432:5432 -d postgres:14
          echo "Installing postgresql-client for health checks..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client -qq
          echo "Waiting for Postgres to accept connections on localhost:5432..."
          export PGPASSWORD=postgres
          for i in $(seq 1 60); do
            pg_isready -h localhost -p 5432 -U postgres && { echo "Postgres ready after $i attempts"; break; }
            echo "Postgres not ready yet ($i/60) â€” sleeping 2s"
            sleep 2
          done

      - name: Diagnostics (quick)
        shell: bash
        run: |
          echo "=== /etc/hosts (first 50 lines) ==="
          sudo sed -n '1,50p' /etc/hosts || true
          echo "=== pg_isready localhost:5432 ==="
          pg_isready -h localhost -p 5432 -U postgres || true
          echo "=== trying psql --version and connection test ==="
          psql --version || true
          echo "SELECT 1" | psql "postgresql://postgres:postgres@localhost:5432/valuation_db" -q -t -A || true

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run migrations
        working-directory: backend
        run: npm run migrate

      - name: Run tests
        working-directory: backend
        run: npm test